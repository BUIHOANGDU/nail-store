<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu B√°nh & C√† Ph√™</title>

  <!-- Fonts gi·ªëng shop -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Dancing+Script&display=swap" rel="stylesheet">

  <style>
    body { background-color:#fff0f5; font-family:'Quicksand', sans-serif; margin:0; }
    header { background-color:#ffe0ec; padding:20px; text-align:center; position:relative; }
    h1 { font-family:'Dancing Script', cursive; font-size:2.5em; color:#e91e63; margin:0; }

    .back-btn { position:absolute; left:20px; top:20px; background:#f48fb1; color:#fff; border:none; border-radius:20px; padding:8px 14px; font-size:1rem; cursor:pointer; }
    .back-btn:hover { background:#ec407a; }

    .cart-btn { position:absolute; right:20px; top:20px; background:#f472b6; color:#fff; border:none; border-radius:20px; padding:8px 16px; font-size:1rem; cursor:pointer; }
    .cart-btn:hover { background:#ec4899; }

    .filter-bar { text-align:center; margin:20px; }
    .filter-bar select { padding:10px; font-size:1rem; border-radius:12px; border:1px solid #f9a8d4; background:#fff; }

    .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:20px; padding:30px; max-width:1000px; margin:auto; }
    .product-card { background:#fff; border-radius:16px; padding:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); text-align:center; transition:transform .2s; display:flex; flex-direction:column; justify-content:space-between; min-height:360px; }
    .product-card:hover { transform:scale(1.03); }
    .product-card img { width:100%; max-height:160px; object-fit:cover; border-radius:10px; cursor:pointer; }
    .product-name { margin-top:10px; font-weight:600; font-size:1rem; color:#d63384; }
    .product-price { color:#777; font-size:.9rem; margin-bottom:8px; }
    .add-to-cart { background:#f472b6; color:#fff; padding:8px 12px; border:none; border-radius:10px; font-size:.9rem; cursor:pointer; }
    .add-to-cart:hover { background:#ec4899; }

    footer { background:#ffe0ec; text-align:center; padding:20px; font-size:.9rem; margin-top:40px; }

    /* Popup chi ti·∫øt & gi·ªè h√†ng */
    .popup-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; z-index:1000; }
    .popup-content { background:#fff; padding:20px; border-radius:16px; max-width:420px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
    .popup-content img { width:100%; max-height:250px; object-fit:cover; border-radius:12px; }
    .popup-close { margin-top:15px; background:#e91e63; color:#fff; border:none; padding:10px 20px; border-radius:12px; font-size:1rem; cursor:pointer; }
    .popup-close:hover { background:#c2185b; }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" onclick="window.location.href='./'">‚Üê Tr·ªü v·ªÅ</button>
    <h1>Menu B√°nh & C√† Ph√™</h1>
    <button class="cart-btn" onclick="showCart()">üõí Gi·ªè (<span id="cart-count">0</span>)</button>
  </header>

  <div class="filter-bar">
    <label for="filter">L·ªçc theo lo·∫°i: </label>
    <select id="filter" onchange="renderFilteredItems()">
      <option value="all">T·∫•t c·∫£</option>
      <option value="coffee">C√† ph√™/ƒê·ªì u·ªëng</option>
      <option value="cake">B√°nh ng·ªçt</option>
    </select>
  </div>

  <div class="product-grid" id="menu-list"></div>

  <footer>
    <p>&copy; 2025 Nail Caf√©. All rights reserved.</p>
  </footer>

  <!-- Popup chi ti·∫øt -->
  <div class="popup-overlay" id="popup">
    <div class="popup-content">
      <img id="popup-img" src="" alt="·∫¢nh m√≥n">
      <h3 id="popup-name"></h3>
      <p id="popup-price"></p>
      <button class="popup-close" onclick="closePopup()">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Popup gi·ªè h√†ng -->
  <div class="popup-overlay" id="cart-popup">
    <div class="popup-content">
      <h3>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>
      <div id="cart-items" style="text-align:left; max-height: 250px; overflow:auto;"></div>
      <p><strong>T·ªïng ti·ªÅn:</strong> <span id="cart-total">0</span> VND</p>
      <button onclick="submitOrder()">X√°c nh·∫≠n ƒë∆°n</button>
      <button onclick="clearCart()">X√≥a t·∫•t c·∫£</button>
      <button class="popup-close" onclick="closeCartPopup()">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC2OVhgdTn15eTSmKhZxw3lkC3Wqz0TmRg",
      authDomain: "nail-fcd76.firebaseapp.com",
      projectId: "nail-fcd76",
      storageBucket: "nail-fcd76.appspot.com",
      messagingSenderId: "292496013690",
      appId: "1:292496013690:web:09dd92cd65115c497e3ec3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ================= CART D√ôNG CHUNG (ƒë·ªìng b·ªô v·ªõi shop) ================= */
    const CART_KEY = 'cart';

    function getCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { return []; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function mergeItems(base, more){
      const map = new Map();
      [...base, ...more].forEach(it=>{
        const k = it.name;
        if(!map.has(k)) map.set(k, {...it});
        else map.get(k).quantity += it.quantity || 1;
      });
      return Array.from(map.values());
    }
    function migrateCart(){ // g·ªôp gi·ªè c≈© cart_menu n·∫øu c√≤n
      const old = JSON.parse(localStorage.getItem('cart_menu') || '[]');
      if(old.length){
        const cur = getCart();
        saveCart(mergeItems(cur, old));
        localStorage.removeItem('cart_menu');
      }
    }
    function addItemToCart({name,imageUrl,price,quantity=1}){
      const c = getCart();
      const i = c.findIndex(x=>x.name===name);
      if(i>-1) c[i].quantity += quantity;
      else c.push({name, imageUrl, price: Number(price)||0, quantity});
      saveCart(c);
    }
    function cartCount(){ return getCart().reduce((s,i)=>s+(i.quantity||0),0); }

    /* ================= MENU (coffee/cake) ================= */
    let allItems = [];

    async function loadMenuItems(){
      const snap = await db.collection('menu').get();
      const catPriority = { coffee:0, cake:1 }; // th·ª© t·ª± nh√≥m
      allItems = snap.docs.map(doc=>{
        const d = doc.data();
        d.createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(0);
        return d;
      });
      allItems.sort((a,b)=>{
        const t = (catPriority[a.category] ?? 9) - (catPriority[b.category] ?? 9);
        if (t !== 0) return t;
        return b.createdAt - a.createdAt; // m·ªõi tr∆∞·ªõc
      });
      renderFilteredItems();
    }

    function renderFilteredItems(){
      const filter = document.getElementById('filter').value;
      const container = document.getElementById('menu-list');
      container.innerHTML = '';
      const list = filter==='all' ? allItems : allItems.filter(i=>i.category===filter);

      list.forEach(d=>{
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <img src="${d.imageUrl}" alt="${escapeHtml(d.name||'')}" onclick="showPopup('${escapeHtml(d.name||'')}', '${d.imageUrl}', '${d.price||0}')">
          <div class="product-info">
            <div class="product-name">${escapeHtml(d.name||'')}</div>
            <div class="product-price">${Number(d.price||0).toLocaleString('vi-VN')} VND</div>
          </div>
          <button class="add-to-cart" onclick="addToCart('${escapeHtml(d.name||'')}', '${d.imageUrl}', '${d.price||0}')">Th√™m v√†o gi·ªè</button>
        `;
        container.appendChild(card);
      });

      if(list.length===0){
        container.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#888">Ch∆∞a c√≥ m√≥n ph√π h·ª£p</div>`;
      }
    }

    /* ================= POPUP CHI TI·∫æT ================= */
    function showPopup(name,img,price){
      document.getElementById('popup-name').innerText = unescapeHtml(name);
      document.getElementById('popup-img').src = img;
      document.getElementById('popup-price').innerText = `${Number(price||0).toLocaleString('vi-VN')} VND`;
      document.getElementById('popup').style.display = 'flex';
    }
    function closePopup(){ document.getElementById('popup').style.display='none'; }

    /* ================= CART UI ================= */
    function addToCart(name,imageUrl,priceText){
      const price = parseInt(String(priceText).replace(/[^\d]/g,'')) || 0;
      addItemToCart({ name, imageUrl, price, quantity:1 });
      updateCartCount();
      alert(`ƒê√£ th√™m "${name}" v√†o gi·ªè!`);
    }
    function updateCartCount(){ document.getElementById('cart-count').innerText = cartCount(); }
    function showCart(){
      const cart = getCart();
      const list = document.getElementById('cart-items');
      const total = document.getElementById('cart-total');
      let sum = 0; list.innerHTML = '';

      if(!cart.length){ list.innerHTML = '<p>Gi·ªè h√†ng ƒëang tr·ªëng.</p>'; }
      else{
        cart.forEach((it,idx)=>{
          const row = document.createElement('div');
          row.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
              <img src="${it.imageUrl}" style="width:60px; height:60px; border-radius:8px; object-fit:cover;">
              <div style="flex:1;">
                <strong>${escapeHtml(it.name)}</strong><br>
                SL: ${it.quantity} √ó ${Number(it.price).toLocaleString('vi-VN')}<br>
                <strong>${(it.price*it.quantity).toLocaleString('vi-VN')}</strong>
              </div>
              <button onclick="removeItem(${idx})">‚ùå</button>
            </div>`;
          list.appendChild(row);
          sum += it.price*it.quantity;
        });
      }
      total.innerText = sum.toLocaleString('vi-VN');
      document.getElementById('cart-popup').style.display = 'flex';
    }
    function removeItem(i){ const c=getCart(); c.splice(i,1); saveCart(c); showCart(); updateCartCount(); }
    function clearCart(){ saveCart([]); showCart(); updateCartCount(); }
    function closeCartPopup(){ document.getElementById('cart-popup').style.display='none'; }

    function submitOrder(){
      const cart = getCart();
      if(!cart.length) return alert('Gi·ªè h√†ng tr·ªëng!');
      const order = {
        source: 'menu',
        items: cart,
        total: cart.reduce((s,i)=>s + i.price*i.quantity, 0),
        createdAt: new Date()
      };
      db.collection('orders').add(order)
        .then(()=>{ alert('üßæ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i!'); clearCart(); })
        .catch(e=>{ console.error(e); alert('L·ªói khi g·ª≠i ƒë∆°n.'); });
    }

    /* ================= UTILS ================= */
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function unescapeHtml(s=''){ const t=document.createElement('textarea'); t.innerHTML=s; return t.value; }

    /* ================= INIT ================= */
    window.onload = () => {
      migrateCart();
      updateCartCount();
      loadMenuItems();
    };
  </script>
</body>
</html>
