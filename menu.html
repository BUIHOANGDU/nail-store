<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Menu B√°nh & C√† Ph√™</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Dancing+Script&display=swap" rel="stylesheet">
  <style>
    body{ background:#fff0f5; font-family:'Quicksand',sans-serif; margin:0 }
    header{ background:#ffe0ec; padding:20px; text-align:center; position:relative }
    h1{ font-family:'Dancing Script',cursive; font-size:2.5em; color:#e91e63; margin:0 }
    .back-btn{ position:absolute; left:20px; top:20px; background:#f48fb1; color:#fff; border:none; border-radius:20px; padding:8px 14px; font-weight:700; cursor:pointer }
    .back-btn:hover{ background:#ec407a }
    .cart-btn{ position:absolute; right:20px; top:20px; background:#f472b6; color:#fff; border:none; border-radius:20px; padding:8px 16px; cursor:pointer }
    .cart-btn:hover{ background:#ec4899 }

    .filter-bar{ text-align:center; margin:20px }
    .filter-bar select{ padding:10px; font-size:1rem; border-radius:12px; border:1px solid #f9a8d4; background:#fff }

    .product-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:20px; padding:30px; max-width:1000px; margin:auto }
    .product-card{ background:#fff; border-radius:16px; padding:12px; box-shadow:0 4px 8px rgba(0,0,0,.1); text-align:center; transition:transform .2s; display:flex; flex-direction:column; justify-content:space-between; min-height:360px }
    .product-card:hover{ transform:scale(1.03) }
    .product-card img{ width:100%; max-height:160px; object-fit:cover; border-radius:10px; cursor:pointer }
    .product-name{ margin-top:10px; font-weight:600; font-size:1rem; color:#d63384 }
    .product-price{ color:#777; font-size:.9rem; margin-bottom:8px }
    .add-to-cart{ background:#f472b6; color:#fff; padding:8px 12px; border:none; border-radius:10px; font-size:.9rem; cursor:pointer }
    .add-to-cart:hover{ background:#ec4899 }

    footer{ background:#ffe0ec; text-align:center; padding:20px; font-size:.9rem; margin-top:40px }

    .popup-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:1000 }
    .popup-content{ background:#fff; padding:20px; border-radius:16px; max-width:420px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.2) }
    .popup-content img{ width:100%; max-height:250px; object-fit:cover; border-radius:12px }
    .popup-close{ margin-top:15px; background:#e91e63; color:#fff; border:none; padding:10px 20px; border-radius:12px; font-size:1rem; cursor:pointer }
    .popup-close:hover{ background:#c2185b }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" onclick="window.location.href='./'">‚Üê Tr·ªü v·ªÅ</button>
    <h1>Menu B√°nh & C√† Ph√™</h1>
    <button class="cart-btn" onclick="showCart()">üõí Gi·ªè (<span id="cart-count">0</span>)</button>
  </header>

  <div class="filter-bar">
    <label for="filter">L·ªçc theo lo·∫°i: </label>
    <select id="filter" onchange="renderFilteredItems()">
      <option value="all">T·∫•t c·∫£</option>
      <option value="coffee">C√† ph√™/ƒê·ªì u·ªëng</option>
      <option value="cake">B√°nh ng·ªçt</option>
    </select>
  </div>

  <div class="product-grid" id="item-list"></div>

  <footer>
    <p>&copy; 2025 Nail Caf√©. All rights reserved.</p>
  </footer>

  <!-- Popup chi ti·∫øt -->
  <div class="popup-overlay" id="popup">
    <div class="popup-content">
      <img id="popup-img" src="" alt="·∫¢nh m√≥n">
      <h3 id="popup-name"></h3>
      <p id="popup-price"></p>
      <button class="popup-close" onclick="closePopup()">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Popup gi·ªè h√†ng -->
  <div class="popup-overlay" id="cart-popup">
    <div class="popup-content">
      <h3>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>
      <div id="cart-items" style="text-align:left; max-height: 250px; overflow:auto;"></div>
      <p><strong>T·ªïng ti·ªÅn:</strong> <span id="cart-total">0</span> VND</p>
      <button onclick="submitOrder()">X√°c nh·∫≠n ƒë∆°n</button>
      <button onclick="clearCart()">X√≥a t·∫•t c·∫£</button>
      <button class="popup-close" onclick="closeCartPopup()">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config (gi·ªëng admin)
    const firebaseConfig = {
      apiKey: "AIzaSyC2OVhgdTn15eTSmKhZxw3lkC3Wqz0TmRg",
      authDomain: "nail-fcd76.firebaseapp.com",
      projectId: "nail-fcd76",
      storageBucket: "nail-fcd76.appspot.com",
      messagingSenderId: "292496013690",
      appId: "1:292496013690:web:09dd92cd65115c497e3ec3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    db.settings({ experimentalAutoDetectLongPolling: true }, { merge: true });

    // ====== DATA & RENDER ======
    let allItems = [];

    function loadMenuItems(){
      db.collection("menu").get().then(snapshot=>{
        const catPriority = { coffee:0, cake:1 }; // th·ª© t·ª± hi·ªÉn th·ªã nh√≥m
        allItems = snapshot.docs.map(doc=>{
          const d = doc.data();
          d.createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : new Date(0);
          return d;
        });
        allItems.sort((a,b)=>{
          const k = (catPriority[a.category] ?? 9) - (catPriority[b.category] ?? 9);
          if (k!==0) return k;
          return b.createdAt - a.createdAt; // m·ªõi tr∆∞·ªõc
        });
        renderFilteredItems();
      }).catch(console.error);
    }

    function renderFilteredItems(){
      const filter = document.getElementById("filter").value;
      const container = document.getElementById("item-list");
      container.innerHTML = "";
      const list = filter==="all" ? allItems : allItems.filter(i=>i.category===filter);

      list.forEach(d=>{
        const div = document.createElement("div");
        div.className = "product-card";
        div.innerHTML = `
          <img src="${d.imageUrl}" alt="${d.name||''}" onclick="showPopup('${escapeHtml(d.name)}','${d.imageUrl}','${d.price}')">
          <div class="product-info">
            <div class="product-name">${escapeHtml(d.name||'')}</div>
            <div class="product-price">${Number(d.price||0).toLocaleString('vi-VN')} VND</div>
          </div>
          <button class="add-to-cart" onclick="addToCart('${escapeHtml(d.name)}','${d.imageUrl}','${d.price}')">Th√™m v√†o gi·ªè</button>
        `;
        container.appendChild(div);
      });

      if(list.length===0){
        container.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#888">Ch∆∞a c√≥ m√≥n ph√π h·ª£p</div>`;
      }
    }

    // ====== POPUP CHI TI·∫æT ======
    function showPopup(name,img,price){
      document.getElementById("popup-name").innerText = unescapeHtml(name);
      document.getElementById("popup-img").src = img;
      document.getElementById("popup-price").innerText = `${Number(price||0).toLocaleString('vi-VN')} VND`;
      document.getElementById("popup").style.display = "flex";
    }
    function closePopup(){ document.getElementById("popup").style.display = "none"; }

    // ====== CART ======
    function addToCart(name,imageUrl,priceText){
      const price = parseInt(String(priceText).replace(/[^\d]/g,"")) || 0;
      let cart = JSON.parse(localStorage.getItem("cart_menu") || "[]");
      const idx = cart.findIndex(x=>x.name===name);
      if(idx>-1) cart[idx].quantity += 1;
      else cart.push({ name, imageUrl, price, quantity:1 });
      localStorage.setItem("cart_menu", JSON.stringify(cart));
      updateCartCount();
      alert(`ƒê√£ th√™m "${name}" v√†o gi·ªè h√†ng!`);
    }

    function updateCartCount(){
      const cart = JSON.parse(localStorage.getItem("cart_menu") || "[]");
      document.getElementById("cart-count").innerText = cart.reduce((s,i)=>s+i.quantity,0);
    }

    function showCart(){
      const cart = JSON.parse(localStorage.getItem("cart_menu") || "[]");
      const list = document.getElementById("cart-items");
      const total = document.getElementById("cart-total");
      let sum = 0; list.innerHTML = "";

      if(cart.length===0){ list.innerHTML = "<p>Gi·ªè h√†ng ƒëang tr·ªëng.</p>"; }
      else{
        cart.forEach((item,idx)=>{
          const row = document.createElement("div");
          row.innerHTML = `
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
              <img src="${item.imageUrl}" style="width:60px;height:60px;border-radius:8px;object-fit:cover" />
              <div style="flex:1">
                <strong>${escapeHtml(item.name)}</strong><br>
                SL: ${item.quantity} √ó ${item.price.toLocaleString("vi-VN")}<br>
                <strong>${(item.price*item.quantity).toLocaleString("vi-VN")}</strong>
              </div>
              <button onclick="removeItem(${idx})">‚ùå</button>
            </div>`;
          list.appendChild(row);
          sum += item.price*item.quantity;
        });
      }
      total.innerText = sum.toLocaleString("vi-VN");
      document.getElementById("cart-popup").style.display = "flex";
    }

    function removeItem(i){
      let cart = JSON.parse(localStorage.getItem("cart_menu") || "[]");
      cart.splice(i,1);
      localStorage.setItem("cart_menu", JSON.stringify(cart));
      showCart(); updateCartCount();
    }
    function clearCart(){ localStorage.removeItem("cart_menu"); showCart(); updateCartCount(); }
    function closeCartPopup(){ document.getElementById("cart-popup").style.display = "none"; }

    // ====== SUBMIT ORDER ======
    function submitOrder(){
      const cart = JSON.parse(localStorage.getItem("cart_menu") || "[]");
      if(cart.length===0) return alert("Gi·ªè h√†ng tr·ªëng!");

      const order = {
        source: "menu", // ph√¢n bi·ªát v·ªõi orders c·ªßa shop
        items: cart,
        total: cart.reduce((s,i)=>s+i.price*i.quantity,0),
        createdAt: new Date()
      };

      db.collection("orders").add(order).then(()=>{
        alert("üßæ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i!");
        clearCart();
      }).catch(err=>{
        console.error(err);
        alert("L·ªói khi g·ª≠i ƒë∆°n.");
      });
    }

    // ====== UTIL ======
    function escapeHtml(s=""){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function unescapeHtml(s=""){ const e=document.createElement("textarea"); e.innerHTML=s; return e.value; }

    // Init
    window.onload = ()=>{ updateCartCount(); loadMenuItems(); };
  </script>
</body>
</html>
