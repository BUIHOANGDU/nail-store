<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Bánh & Cà Phê</title>
  <style>
    body{font-family:sans-serif;background:#fff0f5;padding:20px}
    h1{text-align:center;color:#c2185b}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
    .card{background:white;border-radius:12px;padding:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);text-align:center}
    .card img{width:100%;height:160px;object-fit:cover;border-radius:8px}
    .cart-btn{position:fixed;top:20px;right:20px;background:#e91e63;color:white;padding:8px 14px;border-radius:8px;cursor:pointer}
    #cart-popup{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
    #cart-box{background:white;padding:20px;border-radius:12px;width:90%;max-width:500px;max-height:90%;overflow:auto}
    .back-btn{display:inline-block;margin-bottom:15px;padding:8px 14px;background:#f48fb1;color:white;border-radius:8px;text-decoration:none}
  </style>
</head>
<body>
  <a href="index.html" class="back-btn">← Trở về</a>
  <h1>☕️ Menu Bánh & Cà Phê</h1>
  <div class="cart-btn" onclick="showCart()">🛒 <span id="cart-count">0</span></div>
  <div class="grid" id="menu-list"></div>

  <!-- CART POPUP -->
  <div id="cart-popup">
    <div id="cart-box">
      <h2>🛒 Giỏ hàng</h2>
      <div id="cart-items"></div>
      <p><strong>Tổng:</strong> <span id="cart-total">0</span>đ</p>
      <button onclick="submitOrder()">Gửi đơn</button>
      <button onclick="clearCart()">Xóa giỏ</button>
      <button onclick="document.getElementById('cart-popup').style.display='none'">Đóng</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyC2OVhgdTn15eTSmKhZxw3lkC3Wqz0TmRg",authDomain:"nail-fcd76.firebaseapp.com",projectId:"nail-fcd76",storageBucket:"nail-fcd76.appspot.com",messagingSenderId:"292496013690",appId:"1:292496013690:web:09dd92cd65115c497e3ec3"};
    firebase.initializeApp(firebaseConfig); const db=firebase.firestore();

    // === CART HELPERS === (y chang shop.html)
    const CART_KEY='cart';
    function getCart(){try{return JSON.parse(localStorage.getItem(CART_KEY)||'[]')}catch{return []}}
    function saveCart(c){localStorage.setItem(CART_KEY,JSON.stringify(c))}
    function mergeItems(base,more){const m=new Map();[...base,...more].forEach(it=>{const k=it.name;if(!m.has(k))m.set(k,{...it});else m.get(k).quantity+=(it.quantity||1)});return Array.from(m.values())}
    function migrateCart(){const old=JSON.parse(localStorage.getItem('cart_menu')||'[]');if(old.length){const cur=getCart();saveCart(mergeItems(cur,old));localStorage.removeItem('cart_menu')}}
    function addItemToCart({name,imageUrl,price,quantity=1}){const c=getCart();const i=c.findIndex(x=>x.name===name);if(i>-1)c[i].quantity+=quantity;else c.push({name,imageUrl,price:Number(price)||0,quantity});saveCart(c)}
    function cartCount(){return getCart().reduce((s,i)=>s+(i.quantity||0),0)}

    function updateCartCount(){document.getElementById('cart-count').innerText=cartCount()}
    function addToCart(name,imageUrl,priceText){const p=parseInt(String(priceText).replace(/[^\d]/g,''))||0;addItemToCart({name,imageUrl,price:p});updateCartCount();alert(`Đã thêm "${name}"!`)}

    function showCart(){const c=getCart();const list=document.getElementById('cart-items');const total=document.getElementById('cart-total');let sum=0;list.innerHTML='';if(!c.length){list.innerHTML='<p>Trống</p>'}else{c.forEach((it,idx)=>{list.innerHTML+=`
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
        <img src="${it.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:8px">
        <div style="flex:1">${it.name}<br>SL:${it.quantity} x ${it.price.toLocaleString('vi-VN')}</div>
        <button onclick="removeItem(${idx})">❌</button>
      </div>`;sum+=it.price*it.quantity;});}total.innerText=sum.toLocaleString('vi-VN');document.getElementById('cart-popup').style.display='flex'}
    function removeItem(i){const c=getCart();c.splice(i,1);saveCart(c);showCart();updateCartCount()}
    function clearCart(){saveCart([]);showCart();updateCartCount()}
    function submitOrder(){const c=getCart();if(!c.length)return alert('Trống!');const order={source:'menu',items:c,total:c.reduce((s,it)=>s+it.price*it.quantity,0),createdAt:new Date()};db.collection('orders').add(order).then(()=>{alert('Đã gửi đơn!');clearCart()}).catch(e=>alert('Lỗi:'+e))}

    // Load menu
    async function loadMenu(){const snap=await db.collection('menu').get();const list=document.getElementById('menu-list');let html='';snap.forEach(doc=>{const d=doc.data();html+=`
      <div class="card">
        <img src="${d.imageUrl}" alt="">
        <h3>${d.name}</h3>
        <p>${Number(d.price||0).toLocaleString('vi-VN')}đ</p>
        <button onclick="addToCart('${d.name}','${d.imageUrl}','${d.price}')">Thêm vào giỏ</button>
      </div>`});list.innerHTML=html}
    
    window.onload=()=>{migrateCart();updateCartCount();loadMenu()}
  </script>
</body>
</html>
